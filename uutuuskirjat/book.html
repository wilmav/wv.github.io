<!DOCTYPE html>
<html lang="fi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kirjan tiedot | Kirjavinkit</title>
    <link rel="stylesheet" href="../tyyli.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <a href="../index.html" class="app-logo-link" style="text-decoration:none;">
            <div class="app-title">Sovellukset<span class="app-title-com">.com</span></div>
        </a>
        <nav>
            <ul>
                <li><a href="index.html">← Takaisin</a></li>
            </ul>
        </nav>
        <div style="margin-top: auto; padding: 1rem; font-size: 0.85rem; opacity: 0.8;">
            <p>Kirjavinkit Beta</p>
        </div>
    </header>

    <div class="content-wrapper">
        <main>
            <section class="book-detail">
                <div id="detail-container"
                    style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 2rem;">

                    <!-- Header with Title + Action -->
                    <div
                        style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1rem; flex-wrap:wrap; gap:1rem;">
                        <h2 id="book-title" style="margin:0;">Ladataan...</h2>
                        <button class="btn-accent" id="find-recs-btn">Hae samankaltaisia</button>
                    </div>

                    <div style="display:flex; gap: 2rem; flex-wrap: wrap; align-items: start;">
                        <div id="book-cover"
                            style="width: 160px; aspect-ratio: 2/3; background: #f6f8fa; flex-shrink: 0; border-radius: 4px; overflow:hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        </div>
                        <div class="info" style="flex:1; min-width: 250px;">
                            <!-- Author prominent -->
                            <h3 id="book-author"
                                style="color: #1f2328; margin-top:0; font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem;">
                            </h3>
                            <!-- Year secondary -->
                            <p id="book-year" style="color: #57606a; font-size: 0.95rem; margin-bottom: 1.5rem;"></p>

                            <!-- Scrollable Description -->
                            <div class="scrollable-content">
                                <p id="book-desc"
                                    style="line-height: 1.6; color: #24292f; white-space: pre-wrap; margin:0; font-size: 1rem;">
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Placeholder simple script for interaction
        const params = new URLSearchParams(window.location.search);
        const bookId = params.get('id');

        if (bookId) {
            fetchBookDetails(bookId);
        } else {
            document.getElementById('book-title').textContent = "Virhe: Kirjan tunnistetta ei annettu.";
        }

        async function fetchBookDetails(id) {
            const apiParams = new URLSearchParams();
            apiParams.append('lookfor', id);
            apiParams.append('type', 'id');
            apiParams.append('field[]', 'title');
            apiParams.append('field[]', 'authors');
            apiParams.append('field[]', 'year');
            apiParams.append('field[]', 'summary');
            apiParams.append('field[]', 'images');

            // Allow getting data regardless of format

            const url = `https://api.finna.fi/v1/search?${apiParams.toString()}`;

            try {
                const res = await fetch(url);
                const data = await res.json();

                if (data.records && data.records.length > 0) {
                    let book = data.records[0];
                    renderBook(book);

                    // Automatic enrichment: If summary is missing, try to find a better record
                    if (!book.summary || book.summary.length === 0) {
                        enrichBookData(book.title, extractAuthor(book));
                    }
                } else {
                    document.getElementById('book-title').textContent = "Kirjaa ei löytynyt.";
                }
            } catch (e) {
                console.error(e);
                document.getElementById('book-title').textContent = "Virhe ladattaessa tietoja.";
            }
        }

        async function enrichBookData(title, author) {
            if (!title) return;
            console.log("Attempting to enrich data for", title);

            // Search for other records of the same book (e.g. Helmet libraries often have descriptions)
            const params = new URLSearchParams({
                lookfor: `"${title}" ${author}`, // Quote title for exact phrase match
                type: 'AllFields',
                limit: 5,
                'field[]': ['summary', 'id']
            });

            try {
                const res = await fetch(`https://api.finna.fi/v1/search?${params.toString()}`);
                const data = await res.json();

                if (data.records && data.records.length > 0) {
                    // Find the first record that actually has a summary
                    const betterRecord = data.records.find(r => r.summary && r.summary.length > 0);
                    if (betterRecord) {
                        console.log("Found better description from", betterRecord.id);
                        const desc = Array.isArray(betterRecord.summary) ? betterRecord.summary.join('\n\n') : betterRecord.summary;
                        document.getElementById('book-desc').innerText = desc;
                    }
                }
            } catch (e) {
                console.warn("Enrichment failed", e);
            }
        }

        function extractAuthor(book) {
            if (!book.authors) return "";
            const primary = book.authors.primary || Object.values(book.authors)[0];
            return primary ? Object.keys(primary)[0] : "";
        }

        function renderBook(book) {
            document.getElementById('book-title').textContent = book.title;

            // Author
            const authorName = extractAuthor(book) || "Tuntematon";
            document.getElementById('book-author').textContent = authorName;

            // Year
            document.getElementById('book-year').textContent = book.year || "";

            // Description - handle array usually returned by Finna
            let desc = "Ei kuvausta saatavilla.";
            if (book.summary) {
                desc = Array.isArray(book.summary) ? book.summary.join('\n\n') : book.summary;
            }
            // Use innerText to preserve newlines as separate text blocks
            document.getElementById('book-desc').innerText = desc;

            // Image
            const coverDiv = document.getElementById('book-cover');
            if (book.images && book.images.length > 0) {
                coverDiv.innerHTML = `<img src="https://api.finna.fi${book.images[0]}" alt="${book.title}" style="width:100%; height:100%; object-fit:cover;">`;
            } else {
                coverDiv.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; color:#888;">Ei kuvaa</div>`;
            }
        }

        document.getElementById('find-recs-btn').addEventListener('click', () => {
            // Future: Implement recommendation logic
            alert('Suositteluominaisuus on tulossa pian!');
        });
    </script>
</body>

</html>