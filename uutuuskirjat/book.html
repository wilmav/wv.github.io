<!DOCTYPE html>
<html lang="fi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kirjan tiedot | Kirjavinkit</title>
    <link rel="stylesheet" href="../tyyli.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <a href="../index.html" class="app-logo-link" style="text-decoration:none;">
            <div class="app-title">Sovellukset<span class="app-title-com">.com</span></div>
        </a>
        <nav style="margin-top: auto; margin-bottom: 2rem;">
            <ul>
                <li><a href="../index.html">Etusivu</a></li>
                <li><a href="../kuitulaskuri.html">Kuitulaskuri</a></li>
                <li><a href="../SpotVaiFix.html">SpotVaiFix</a></li>
                <li><a href="index.html"><strong>Kirjavinkit</strong></a></li>
                <li><a href="../yhteystiedot.html">Yhteystiedot</a></li>
            </ul>
        </nav>
    </header>

    <div class="content-wrapper">
        <main>
            <section class="book-detail">
                <div id="detail-container"
                    style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 2rem;">

                    <!-- Header with Title -->
                    <div
                        style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1rem; flex-wrap:wrap; gap:1rem; width:100%;">
                        <h2 id="book-title" style="margin:0; flex:1;">Ladataan...</h2>
                        <!-- Info Icon / Disclaimer -->
                        <div class="info-icon-container" tabindex="0" style="position:relative;">
                            <div class="info-icon">i</div>
                            <div class="info-tooltip" style="right:0; left:auto; transform:none; width:280px;">
                                <p><strong>Lähteet:</strong></p>
                                <ul style="margin: 4px 0 8px 1.2rem; padding:0; list-style-type: disc;">
                                    <li><a href="https://www.finna.fi" target="_blank" rel="noopener">Finna.fi</a>
                                        (Perustiedot/Aiheet)</li>
                                    <li><a href="https://books.google.com" target="_blank" rel="noopener">Google
                                            Books</a> (Kuvaukset ja kannet)</li>
                                    <li><a href="https://openlibrary.org" target="_blank" rel="noopener">Open
                                            Library</a> (Arvostelut ja kannet)</li>
                                </ul>
                                <p>Tiedot ovat suuntaa-antavia.</p>
                            </div>
                        </div>
                    </div>

                    <div style="display:flex; gap: 2rem; flex-wrap: wrap; align-items: start;">
                        <div id="book-cover"
                            style="width: 160px; aspect-ratio: 2/3; background: #f6f8fa; flex-shrink: 0; border-radius: 4px; overflow:hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        </div>
                        <div class="info" style="flex:1; min-width: 250px;">
                            <!-- Author prominent -->
                            <h3 id="book-author"
                                style="color: #1f2328; margin-top:0; font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem;">
                            </h3>

                            <!-- Original Title -->
                            <div id="book-original-title"
                                style="font-size: 0.9rem; color: #57606a; font-style: italic; margin-bottom: 0.5rem; display:none;">
                            </div>

                            <!-- Year secondary -->
                            <p id="book-year" style="color: #57606a; font-size: 0.95rem; margin-bottom: 1.5rem;"></p>

                            <!-- Reviews Section (Hidden until valid) -->
                            <div id="reviews-container" style="margin-bottom: 1.5rem; display:none;">
                                <h4 style="margin:0 0 8px 0; font-size:1rem;">Arvostelut</h4>
                                <div id="review-content"></div>
                            </div>

                            <!-- Scrollable Description -->
                            <div class="scrollable-content">
                                <p id="book-desc"
                                    style="line-height: 1.6; color: #24292f; white-space: pre-wrap; margin:0; font-size: 1rem;">
                                </p>
                            </div>

                            <!-- Similar Books -->
                            <div id="similar-container" style="margin-top: 2rem; display:none;">
                                <h4 style="margin-bottom:1rem;">Samankaltaisia kirjoja</h4>
                                <div id="similar-list"
                                    style="display:flex; gap:16px; overflow-x:auto; padding-bottom:8px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Placeholder simple script for interaction
        const params = new URLSearchParams(window.location.search);
        const bookId = params.get('id');

        if (bookId) {
            fetchBookDetails(bookId);
        } else {
            document.getElementById('book-title').textContent = "Virhe: Kirjan tunnistetta ei annettu.";
        }

        async function fetchBookDetails(id) {
            const apiParams = new URLSearchParams();
            apiParams.append('lookfor', id);
            apiParams.append('type', 'id');
            apiParams.append('field[]', 'title');
            apiParams.append('field[]', 'authors');
            apiParams.append('field[]', 'year');
            apiParams.append('field[]', 'summary');
            apiParams.append('field[]', 'images');
            apiParams.append('field[]', 'subjects');
            apiParams.append('field[]', 'genres');        // For minimal filter
            apiParams.append('field[]', 'targetAudience');// For minimal filter
            apiParams.append('field[]', 'isbn');
            apiParams.append('field[]', 'notes');

            const url = `https://api.finna.fi/v1/search?${apiParams.toString()}`;

            try {
                const res = await fetch(url);
                const data = await res.json();

                if (data.records && data.records.length > 0) {
                    let book = data.records[0];

                    // Extract Original Title early
                    let originalTitle = "";
                    if (book.notes) {
                        const otNote = book.notes.find(n => n.includes("Alkuteos:") || n.includes("Alkuperäisteos:"));
                        if (otNote) {
                            originalTitle = otNote.replace("Alkuteos:", "").replace("Alkuperäisteos:", "").trim();
                        }
                    }
                    book.parsedOriginalTitle = originalTitle; // Store for usage

                    renderBook(book); // Render initial state

                    // ENRICHMENT PIPELINE
                    if (!book.summary || book.summary.length === 0) {
                        enrichWithFinnaCopies(book.title, extractAuthor(book));
                    }

                    // Google Books Enrichment (Covers & Summaries)
                    if ((!book.images || book.images.length === 0) || (!book.summary)) {
                        enrichWithGoogleBooks(book, originalTitle);
                    }

                    if (book.isbn) fetchReviews(book.isbn);
                    else fetchReviewsByTitle(book.title, extractAuthor(book));

                    findSimilarBooks(book);

                } else {
                    document.getElementById('book-title').textContent = "Kirjaa ei löytynyt.";
                }
            } catch (e) {
                console.error(e);
                document.getElementById('book-title').textContent = "Virhe ladattaessa tietoja.";
            }
        }

        async function enrichWithGoogleBooks(book, originalTitle) {
            let q = "";
            let isbn = (book.isbn && book.isbn.length) ? book.isbn[0] : null;

            if (isbn) {
                q = `isbn:${isbn}`;
            } else {
                const author = extractAuthor(book);
                q = `intitle:${encodeURIComponent(book.title)}+inauthor:${encodeURIComponent(author)}`;
            }

            try {
                let res = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${q}&maxResults=1`);
                let data = await res.json();

                // NO FALLBACK to original title anymore.
                // Strict matching only to avoid English covers/descriptions for Finnish books.

                if (data.items && data.items.length > 0) {
                    const info = data.items[0].volumeInfo;

                    // 1. Enrich Description if missing
                    const descEl = document.getElementById('book-desc');
                    if (descEl.innerText === "" && info.description) {
                        descEl.innerText = info.description;
                        descEl.parentElement.style.display = 'block';
                        // Add attribution
                        descEl.parentElement.insertAdjacentHTML('beforeend', '<div style="font-size:0.8rem; color:#888; margin-top:8px;">Kuvaus: Google Books</div>');
                    }

                    // 2. Enrich Cover if missing
                    const coverDiv = document.getElementById('book-cover');
                    // Check if we currently show "Ei kuvaa" (placeholder)
                    const hasImage = coverDiv.querySelector('img') && !coverDiv.querySelector('img').src.includes('openlibrary');

                    if (!hasImage && info.imageLinks) {
                        const imgUrl = info.imageLinks.thumbnail || info.imageLinks.smallThumbnail;
                        if (imgUrl) {
                            // Use zoom=1 (thumbnail) which is reliable.
                            // Forcing zoom=0 or zoom=2 often results in "Image Not Available" placeholder.
                            const safeUrl = imgUrl.replace('&edge=curl', ''); // Remove curl for flat image
                            coverDiv.innerHTML = `<img src="${safeUrl}" alt="${book.title}" style="width:100%; height:100%; object-fit:cover;">`;
                        }
                    }
                } else if (!isbn) {
                    // Fallback: If no google result and we want cover, try OpenLibrary logic in renderBook
                }
            } catch (e) { }
        }

        async function enrichWithFinnaCopies(title, author) {
            if (!title) return;
            const params = new URLSearchParams({
                lookfor: `"${title}" ${author}`,
                type: 'AllFields',
                limit: 5,
                'field[]': ['summary', 'id']
            });
            try {
                const res = await fetch(`https://api.finna.fi/v1/search?${params.toString()}`);
                const data = await res.json();
                if (data.records && data.records.length > 0) {
                    const betterRecord = data.records.find(r => r.summary && r.summary.length > 0);
                    if (betterRecord) {
                        const desc = Array.isArray(betterRecord.summary) ? betterRecord.summary.join('\n\n') : betterRecord.summary;
                        const dEl = document.getElementById('book-desc');
                        if (dEl.innerText === "") {
                            dEl.innerText = desc;
                            dEl.parentElement.style.display = 'block';
                        }
                    }
                }
            } catch (e) { }
        }

        async function findSimilarBooks(sourceBook) {
            // 0. PREPARE LANGUAGE FILTER
            const storedLangs = localStorage.getItem('selectedLanguages');
            const selectedLangs = storedLangs ? JSON.parse(storedLangs) : ['fin', 'swe', 'eng'];
            const langQuery = selectedLangs.map(l => `language:${l}`).join(' OR ');

            // 1. CLEAN & PREPARE DATA
            const formatBlocklist = ['äänikirjat', 'e-kirjat', 'cd-levyt', 'verkkoaineisto', 'pokkarit', 'isokokoiset kirjat', 'celia-aineisto'];
            const genericGenreBlocklist = ['kaunokirjallisuus', 'romaanit', 'suomenkielinen kirjallisuus', 'käännöskirjallisuus'];

            // Extract and cleanup Genres
            const rawGenres = sourceBook.genres ? sourceBook.genres.flat() : [];
            const cleanGenres = rawGenres.filter(g => {
                const lower = g.toLowerCase();
                return !formatBlocklist.some(f => lower.includes(f));
            });
            const specificGenres = cleanGenres.filter(g => !genericGenreBlocklist.includes(g.toLowerCase()));

            // Extract and cleanup Subjects (Themes)
            const rawSubjects = sourceBook.subjects ? sourceBook.subjects.flat() : [];
            const cleanSubjects = rawSubjects
                .map(s => s.replace(/\s*\(.*?\)\s*/g, '').trim()) // Remove text in parens e.g. "(fiktiivinen hahmo)"
                .filter(s => {
                    const lower = s.toLowerCase();
                    return s.length > 3 &&
                        !genericGenreBlocklist.includes(lower) &&
                        !formatBlocklist.some(f => lower.includes(f));
                });

            const uniqueSubjects = [...new Set(cleanSubjects)]; // Deduplicate after cleaning

            const audience = sourceBook.targetAudience ? sourceBook.targetAudience.flat() : [];

            // 2. BUILD QUERY
            if (specificGenres.length === 0 && uniqueSubjects.length === 0) {
                // FALLBACK: If no metadata (e.g. 2026 book), search by AUTHOR
                const author = extractAuthor(sourceBook);
                if (author) {
                    // Search for other books by this author
                    const query = `author:"${author}" AND (${langQuery})`;
                    return executeRecommendationSearch(query, sourceBook, [], [], [], true);
                }
                return;
            }

            const terms = [];
            specificGenres.slice(0, 3).forEach(g => terms.push(`genre:"${g}"`));
            uniqueSubjects.slice(0, 5).forEach(s => terms.push(`topic:"${s}"`));

            const query = `(${terms.join(' OR ')}) AND (${langQuery})`;

            executeRecommendationSearch(query, sourceBook, uniqueSubjects, specificGenres, audience, false);
        }

        async function executeRecommendationSearch(query, sourceBook, uniqueSubjects, specificGenres, audience, isAuthorFallback) {
            // Fetch candidates
            const url = `https://api.finna.fi/v1/search?lookfor=${encodeURIComponent(query)}&limit=30&field[]=id&field[]=title&field[]=images&field[]=year&field[]=subjects&field[]=genres&field[]=targetAudience&field[]=authors&field[]=isbn`;

            try {
                const res = await fetch(url);
                const data = await res.json();

                // Exclude self by ID AND Title
                let candidates = data.records ? data.records.filter(r => {
                    if (r.id === sourceBook.id) return false;
                    if (r.title.toLowerCase().trim() === sourceBook.title.toLowerCase().trim()) return false;
                    return true;
                }) : [];

                // STRICT FILTER: Fiction vs Non-Fiction separation

                const getTags = (b) => [...(b.genres || []).flat(), ...(b.subjects || []).flat()].map(t => t.toLowerCase());

                const isFiction = (b) => {
                    const tags = getTags(b);
                    const fictionKeywords = [
                        'kaunokirjallisuus', 'romaanit', 'kertomakirjallisuus',
                        'fiction', 'novel', 'novellit', 'runot', 'draama',
                        'jännityskirjallisuus', 'rikoskirjallisuus', 'fantasia', 'scifi',
                        'skönlitteratur', 'deckare', 'thriller', 'mystery', 'sagor'
                    ];
                    return tags.some(t => fictionKeywords.some(kw => t.includes(kw)));
                };

                const sourceIsFiction = isFiction(sourceBook);

                // DEDUPLICATION BY TITLE
                const uniqueMap = new Map();
                candidates.forEach(cand => {
                    let clean = cand.title;
                    // Generic cleaning
                    ["Alkuteos:", "alkuteos:", "Alkuperäisteos:", ". Suomi"].forEach(term => {
                        if (clean.includes(term)) clean = clean.split(term)[0];
                    });
                    // Aggressive cleaning: split by colon to ignore subtitles like ": romaani"
                    if (clean.includes(':')) {
                        clean = clean.split(':')[0];
                    }
                    if (clean.includes('/')) clean = clean.split('/')[0];
                    clean = clean.trim().toLowerCase().replace(/\.$/, ''); // Remove trailing dot

                    if (uniqueMap.has(clean)) {
                        const existing = uniqueMap.get(clean);
                        // Prefer existing if it has image, otherwise take new if it has image
                        if (!existing.images?.length && cand.images?.length) {
                            uniqueMap.set(clean, cand);
                        }
                    } else {
                        uniqueMap.set(clean, cand);
                    }
                });
                candidates = Array.from(uniqueMap.values());

                candidates = candidates.filter(cand => {
                    const candIsFiction = isFiction(cand);
                    if (sourceIsFiction) return candIsFiction;
                    return !candIsFiction;
                });

                // 3. RANKING ALGORITHM
                const scoredCandidates = candidates.map(cand => {
                    let score = 0;
                    let reasons = [];

                    if (isAuthorFallback) {
                        // Simple author match score
                        score = 10;
                        reasons.push(`Kirjailija: ${extractAuthor(sourceBook)}`);
                    } else {
                        // ... Standard Scoring ...
                        // A. THEME/SUBJECT MATCH
                        if (uniqueSubjects.length > 0 && cand.subjects) {
                            const candSubjects = cand.subjects.flat().map(s => s.replace(/\s*\(.*?\)\s*/g, '').trim());
                            const commonSubjects = candSubjects.filter(s => uniqueSubjects.includes(s));
                            const uniqueCommon = [...new Set(commonSubjects)];

                            if (uniqueCommon.length > 0) {
                                score += 20 * uniqueCommon.length;
                                reasons.push(`Teemat: ${uniqueCommon.slice(0, 3).join(', ')}`);
                            }
                        }

                        // B. GENRE MATCH
                        let genreMatchFound = false;
                        if (specificGenres.length > 0 && cand.genres) {
                            const candGenres = cand.genres.flat();
                            const commonGenres = candGenres.filter(g => specificGenres.includes(g));
                            const uniqueGenreCalls = [...new Set(commonGenres)];
                            if (uniqueGenreCalls.length > 0) {
                                score += 15 * uniqueGenreCalls.length;
                                reasons.push(`Yhteinen genre: ${uniqueGenreCalls.slice(0, 2).join(', ')}`);
                                genreMatchFound = true;
                            }
                        }

                        // IF NO GENRE MATCH, STILL SHOW GENRE INFO
                        if (!genreMatchFound && cand.genres) {
                            const genericGenreBlocklist = ['kaunokirjallisuus', 'romaanit', 'suomenkielinen kirjallisuus', 'käännöskirjallisuus'];
                            const formatBlocklist = ['äänikirjat', 'e-kirjat', 'cd-levyt', 'verkkoaineisto', 'pokkarit', 'isokokoiset kirjat', 'celia-aineisto'];
                            const candSpecific = cand.genres.flat().filter(g => {
                                const lower = g.toLowerCase();
                                return !genericGenreBlocklist.includes(lower) && !formatBlocklist.some(f => lower.includes(f));
                            });
                            if (candSpecific.length > 0) {
                                reasons.unshift(`Genre: ${candSpecific[0]}`);
                            }
                        }

                        // C. AUDIENCE MATCH
                        if (audience.length > 0 && cand.targetAudience) {
                            const commonAudience = cand.targetAudience.filter(a => audience.includes(a));
                            if (commonAudience.length > 0) {
                                score += 10;
                            }
                        }

                        // D. AUTHOR BONUS
                        const sourceAuth = extractAuthor(sourceBook);
                        const candAuth = extractAuthor(cand);
                        if (sourceAuth && candAuth && sourceAuth === candAuth) {
                            score += 5;
                        }
                    } // end else

                    return { book: cand, score, reasons };
                });

                const finalPicks = scoredCandidates
                    .filter(c => c.score > 0)
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 6);

                if (finalPicks.length > 0) {
                    renderSimilar(finalPicks);
                }
            } catch (e) { console.warn(e); }
        }

        function renderSimilar(scoredBooks) {
            const container = document.getElementById('similar-container');
            const list = document.getElementById('similar-list');
            container.style.display = 'block';
            list.innerHTML = '';

            scoredBooks.forEach(item => {
                const b = item.book;
                // Unique reasons, join with newlines
                const reasonText = [...new Set(item.reasons)].join('\n');

                // Image Logic: Finna -> Google Fallback -> OpenLibrary Fallback -> Placeholder
                let imgSrc = (b.images && b.images.length) ? `https://api.finna.fi${b.images[0]}` : '';

                // We'll rely on the onerror handlers for Google/OL fallbacks in the HTML string, 
                // but strictly speaking, we don't have the Google URL here easily without async.
                // For recommendations, sticking to Finna + OpenLibrary is fastest.
                if (!imgSrc && b.isbn) {
                    const isbn = Array.isArray(b.isbn) ? b.isbn[0] : b.isbn;
                    imgSrc = `https://covers.openlibrary.org/b/isbn/${isbn}-M.jpg`;
                }

                const el = document.createElement('div');
                el.style.cssText = "width: 100px; cursor: pointer; flex-shrink:0;";
                el.onclick = () => window.location.href = `book.html?id=${b.id}`;
                el.title = reasonText; // Simple tooltip

                el.innerHTML = `
                    <div style="width:100%; aspect-ratio:2/3; background:#f0f0f0; border-radius:4px; overflow:hidden; margin-bottom:4px; position:relative;">
                        ${imgSrc ? `<img src="${imgSrc}" style="width:100%; height:100%; object-fit:cover;" onerror="this.style.display='none'">` : '<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#ccc; font-size:0.8rem;">Ei kuvaa</div>'}
                    </div>
                    <div style="font-size:0.75rem; font-weight:600; line-height:1.2; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; margin-bottom:2px;">${b.title}</div>
                    <div style="font-size:0.7rem; color:#666; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${extractAuthor(b)}</div>
                `;
                list.appendChild(el);
            });
        }

        async function fetchReviews(isbn) {
            if (Array.isArray(isbn)) isbn = isbn[0];
            const url = `https://openlibrary.org/search.json?q=${isbn}&fields=ratings_average,ratings_count,key&limit=1`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.docs && data.docs.length > 0 && data.docs[0].ratings_average) {
                    renderRating(data.docs[0]);
                }
            } catch (e) { }
        }

        async function fetchReviewsByTitle(title, author) {
            const url = `https://openlibrary.org/search.json?title=${encodeURIComponent(title)}&author=${encodeURIComponent(author)}&fields=ratings_average,ratings_count&limit=1`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.docs && data.docs.length > 0 && data.docs[0].ratings_average) {
                    renderRating(data.docs[0]);
                }
            } catch (e) { }
        }

        function renderRating(data) {
            const container = document.getElementById('reviews-container');
            container.style.display = 'block';
            const score = Math.round(data.ratings_average * 10) / 10;
            const count = data.ratings_count;
            const stars = "★".repeat(Math.round(score)) + "☆".repeat(5 - Math.round(score));

            document.getElementById('review-content').innerHTML = `
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="color:#e6b800; font-size:1.2rem; cursor:help;" title="Lähde: OpenLibrary">${stars}</span>
                    <span style="font-weight:700; font-size:1.1rem;">${score}</span>
                    <span style="color:#57606a; font-size:0.9rem;">(${count} arvostelua)</span>
                </div>
            `;
        }

        async function enrichWithFinnaCopies(title, author) {
            if (!title) return;
            console.log("Attempting to enrich data via Finna copies for", title);

            // Search for other records (e.g. audiobook, ebook) that might have a summary
            const params = new URLSearchParams({
                lookfor: `"${title}" ${author}`,
                type: 'AllFields',
                limit: 5,
                'field[]': ['summary', 'id']
            });

            try {
                const res = await fetch(`https://api.finna.fi/v1/search?${params.toString()}`);
                const data = await res.json();

                if (data.records && data.records.length > 0) {
                    // Find any record that has a non-empty summary
                    const betterRecord = data.records.find(r => r.summary && r.summary.length > 0);

                    if (betterRecord) {
                        console.log("Found better description from sibling record:", betterRecord.id);
                        const desc = Array.isArray(betterRecord.summary) ? betterRecord.summary.join('\n\n') : betterRecord.summary;

                        // Update UI if current description is empty
                        const dEl = document.getElementById('book-desc');
                        if (dEl.innerText.trim() === "") {
                            dEl.innerText = desc;
                            dEl.parentElement.style.display = 'block';
                        }
                    }
                }
            } catch (e) {
                console.warn("Finna enrichment failed", e);
            }
        }

        function extractAuthor(book) {
            if (!book.authors) return "";
            const primary = book.authors.primary || Object.values(book.authors)[0];
            return primary ? Object.keys(primary)[0] : "";
        }

        function renderBook(book) {
            document.getElementById('book-title').textContent = book.title;

            // Original Title
            let ot = "";
            if (book.notes) {
                const otNote = book.notes.find(n => n.includes("Alkuteos:") || n.includes("Alkuperäisteos:"));
                if (otNote) ot = otNote;
            }
            if (ot) {
                document.getElementById('book-original-title').textContent = ot;
                document.getElementById('book-original-title').style.display = 'block';
            }

            const authorName = extractAuthor(book) || "Tuntematon";
            document.getElementById('book-author').textContent = authorName;
            document.getElementById('book-year').textContent = book.year || "";

            let desc = "";
            if (book.summary && book.summary.length > 0) {
                desc = Array.isArray(book.summary) ? book.summary.join('\n\n') : book.summary;
            }

            const descEl = document.getElementById('book-desc');
            const descContainer = descEl.parentElement;

            if (desc) {
                descEl.innerText = desc;
                descContainer.style.display = 'block';
            } else {
                descEl.innerText = "";
                descContainer.style.display = 'none';
            }

            // Image with Fallback (Finna -> OpenLibrary -> Placeholder)
            const coverDiv = document.getElementById('book-cover');
            let imgSrc = (book.images && book.images.length > 0) ? `https://api.finna.fi${book.images[0]}` : null;

            if (!imgSrc && book.isbn) {
                const isbn = Array.isArray(book.isbn) ? book.isbn[0] : book.isbn;
                imgSrc = `https://covers.openlibrary.org/b/isbn/${isbn}-L.jpg`; // Use Large size for main cover
            }

            if (imgSrc) {
                coverDiv.innerHTML = `<img src="${imgSrc}" alt="${book.title}" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentElement.innerHTML='<div style=\\'display:flex; align-items:center; justify-content:center; height:100%; color:#888;\\'>Ei kuvaa</div>'">`;
            } else {
                coverDiv.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; color:#888;">Ei kuvaa</div>`;
            }
        }
    </script>
</body>

</html>