<!DOCTYPE html>
<html lang="fi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kirjan tiedot | Kirjavinkit</title>
    <link rel="stylesheet" href="../tyyli.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <a href="../index.html" class="app-logo-link" style="text-decoration:none;">
            <div class="app-title">Sovellukset<span class="app-title-com">.com</span></div>
        </a>
        <nav>
            <ul>
                <li><a href="index.html">← Takaisin</a></li>
            </ul>
        </nav>
        <div style="margin-top: auto; padding: 1rem; font-size: 0.85rem; opacity: 0.8;">
            <p>Kirjavinkit Beta</p>
        </div>
    </header>

    <div class="content-wrapper">
        <main>
            <section class="book-detail">
                <div id="detail-container"
                    style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 2rem;">

                    <!-- Header with Title -->
                    <div
                        style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1rem; flex-wrap:wrap; gap:1rem;">
                        <h2 id="book-title" style="margin:0;">Ladataan...</h2>
                    </div>

                    <div style="display:flex; gap: 2rem; flex-wrap: wrap; align-items: start;">
                        <div id="book-cover"
                            style="width: 160px; aspect-ratio: 2/3; background: #f6f8fa; flex-shrink: 0; border-radius: 4px; overflow:hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                        </div>
                        <div class="info" style="flex:1; min-width: 250px;">
                            <!-- Author prominent -->
                            <h3 id="book-author"
                                style="color: #1f2328; margin-top:0; font-size: 1.1rem; font-weight: 600; margin-bottom: 0.25rem;">
                            </h3>

                            <!-- Original Title -->
                            <div id="book-original-title"
                                style="font-size: 0.9rem; color: #57606a; font-style: italic; margin-bottom: 0.5rem; display:none;">
                            </div>

                            <!-- Year secondary -->
                            <p id="book-year" style="color: #57606a; font-size: 0.95rem; margin-bottom: 1.5rem;"></p>

                            <!-- Reviews Section (Hidden until valid) -->
                            <div id="reviews-container" style="margin-bottom: 1.5rem; display:none;">
                                <h4 style="margin:0 0 8px 0; font-size:1rem;">Arvostelut</h4>
                                <div id="review-content"></div>
                            </div>

                            <!-- Scrollable Description -->
                            <div class="scrollable-content">
                                <p id="book-desc"
                                    style="line-height: 1.6; color: #24292f; white-space: pre-wrap; margin:0; font-size: 1rem;">
                                </p>
                            </div>

                            <!-- Similar Books -->
                            <div id="similar-container" style="margin-top: 2rem; display:none;">
                                <h4 style="margin-bottom:1rem;">Samankaltaisia kirjoja</h4>
                                <div id="similar-list"
                                    style="display:flex; gap:16px; overflow-x:auto; padding-bottom:8px;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script>
        // Placeholder simple script for interaction
        const params = new URLSearchParams(window.location.search);
        const bookId = params.get('id');

        if (bookId) {
            fetchBookDetails(bookId);
        } else {
            document.getElementById('book-title').textContent = "Virhe: Kirjan tunnistetta ei annettu.";
        }

        async function fetchBookDetails(id) {
            const apiParams = new URLSearchParams();
            apiParams.append('lookfor', id);
            apiParams.append('type', 'id');
            apiParams.append('field[]', 'title');
            apiParams.append('field[]', 'authors');
            apiParams.append('field[]', 'year');
            apiParams.append('field[]', 'summary');
            apiParams.append('field[]', 'images');
            apiParams.append('field[]', 'subjects');
            apiParams.append('field[]', 'genres');        // For minimal filter
            apiParams.append('field[]', 'targetAudience');// For minimal filter
            apiParams.append('field[]', 'isbn');
            apiParams.append('field[]', 'notes');

            const url = `https://api.finna.fi/v1/search?${apiParams.toString()}`;

            try {
                const res = await fetch(url);
                const data = await res.json();

                if (data.records && data.records.length > 0) {
                    let book = data.records[0];
                    renderBook(book);

                    if (!book.summary || book.summary.length === 0) {
                        enrichBookData(book.title, extractAuthor(book));
                    }

                    // Auto-load reviews and similar
                    if (book.isbn) fetchReviews(book.isbn);
                    else fetchReviewsByTitle(book.title, extractAuthor(book));

                    // Trigger recommendation engine
                    findSimilarBooks(book);

                } else {
                    document.getElementById('book-title').textContent = "Kirjaa ei löytynyt.";
                }
            } catch (e) {
                console.error(e);
                document.getElementById('book-title').textContent = "Virhe ladattaessa tietoja.";
            }
        }

        async function findSimilarBooks(sourceBook) {
            // 0. PREPARE LANGUAGE FILTER
            const storedLangs = localStorage.getItem('selectedLanguages');
            const selectedLangs = storedLangs ? JSON.parse(storedLangs) : ['fin', 'swe', 'eng'];
            const langQuery = selectedLangs.map(l => `language:${l}`).join(' OR ');

            // 1. CLEAN & PREPARE DATA
            const formatBlocklist = ['äänikirjat', 'e-kirjat', 'cd-levyt', 'verkkoaineisto', 'pokkarit', 'isokokoiset kirjat', 'celia-aineisto'];
            const genericGenreBlocklist = ['kaunokirjallisuus', 'romaanit', 'suomenkielinen kirjallisuus', 'käännöskirjallisuus'];

            // Extract and cleanup Genres
            const rawGenres = sourceBook.genres ? sourceBook.genres.flat() : [];
            const cleanGenres = rawGenres.filter(g => {
                const lower = g.toLowerCase();
                return !formatBlocklist.some(f => lower.includes(f));
            });
            const specificGenres = cleanGenres.filter(g => !genericGenreBlocklist.includes(g.toLowerCase()));

            // Extract and cleanup Subjects (Themes)
            const rawSubjects = sourceBook.subjects ? sourceBook.subjects.flat() : [];
            const cleanSubjects = rawSubjects
                .map(s => s.replace(/\s*\(.*?\)\s*/g, '').trim()) // Remove text in parens e.g. "(fiktiivinen hahmo)"
                .filter(s => {
                    const lower = s.toLowerCase();
                    return s.length > 3 &&
                        !genericGenreBlocklist.includes(lower) &&
                        !formatBlocklist.some(f => lower.includes(f));
                });

            const uniqueSubjects = [...new Set(cleanSubjects)]; // Deduplicate after cleaning

            const audience = sourceBook.targetAudience ? sourceBook.targetAudience.flat() : [];

            // 2. BUILD QUERY
            if (specificGenres.length === 0 && uniqueSubjects.length === 0) return;

            const terms = [];
            specificGenres.slice(0, 3).forEach(g => terms.push(`genre:"${g}"`));
            uniqueSubjects.slice(0, 5).forEach(s => terms.push(`topic:"${s}"`));

            const query = `(${terms.join(' OR ')}) AND (${langQuery})`;

            // Fetch candidates
            const url = `https://api.finna.fi/v1/search?lookfor=${encodeURIComponent(query)}&limit=30&field[]=id&field[]=title&field[]=images&field[]=year&field[]=subjects&field[]=genres&field[]=targetAudience&field[]=authors&field[]=isbn`;

            try {
                const res = await fetch(url);
                const data = await res.json();

                // Exclude self by ID AND Title
                let candidates = data.records ? data.records.filter(r => {
                    if (r.id === sourceBook.id) return false;
                    if (r.title.toLowerCase().trim() === sourceBook.title.toLowerCase().trim()) return false;
                    return true;
                }) : [];

                // STRICT FILTER: Fiction vs Non-Fiction separation
                // "Tietokirjallisuus" is a strong marker in Finna.
                const isNonFiction = (b) => {
                    const allTags = [...(b.genres || []).flat(), ...(b.subjects || []).flat()].map(t => t.toLowerCase());
                    return allTags.includes('tietokirjallisuus') || allTags.includes('non-fiction');
                };

                const sourceIsFact = isNonFiction(sourceBook);

                candidates = candidates.filter(cand => {
                    const candIsFact = isNonFiction(cand);
                    // If source is fact, we only want fact.
                    if (sourceIsFact) return candIsFact;
                    // If source is fiction (not fact), we reject fact.
                    return !candIsFact;
                });

                // 3. RANKING ALGORITHM
                const scoredCandidates = candidates.map(cand => {
                    let score = 0;
                    let reasons = [];

                    // A. THEME/SUBJECT MATCH
                    if (uniqueSubjects.length > 0 && cand.subjects) {
                        // Clean cand subjects too for matching
                        const candSubjects = cand.subjects.flat().map(s => s.replace(/\s*\(.*?\)\s*/g, '').trim());
                        const commonSubjects = candSubjects.filter(s => uniqueSubjects.includes(s));
                        const uniqueCommon = [...new Set(commonSubjects)]; // Dedupe

                        if (uniqueCommon.length > 0) {
                            score += 20 * uniqueCommon.length;
                            reasons.push(`Teemat: ${uniqueCommon.slice(0, 3).join(', ')}`);
                        }
                    }

                    // B. GENRE MATCH
                    if (specificGenres.length > 0 && cand.genres) {
                        const candGenres = cand.genres.flat();
                        const commonGenres = candGenres.filter(g => specificGenres.includes(g));
                        const uniqueGenreCalls = [...new Set(commonGenres)];
                        if (uniqueGenreCalls.length > 0) {
                            score += 15 * uniqueGenreCalls.length;
                            reasons.push(`Genre: ${uniqueGenreCalls.slice(0, 2).join(', ')}`);
                        }
                    }

                    // C. AUDIENCE MATCH
                    if (audience.length > 0 && cand.targetAudience) {
                        const commonAudience = cand.targetAudience.filter(a => audience.includes(a));
                        if (commonAudience.length > 0) {
                            score += 10;
                            reasons.push(`Kohdeyleisö: ${commonAudience.join(', ')}`);
                        }
                    }

                    // D. AUTHOR BONUS
                    const sourceAuth = extractAuthor(sourceBook);
                    const candAuth = extractAuthor(cand);
                    if (sourceAuth && candAuth && sourceAuth === candAuth) {
                        score += 5;
                    }

                    return { book: cand, score, reasons };
                });

                const finalPicks = scoredCandidates
                    .filter(c => c.score > 0)
                    .sort((a, b) => b.score - a.score)
                    .slice(0, 6);

                if (finalPicks.length > 0) {
                    renderSimilar(finalPicks);
                }
            } catch (e) { console.warn(e); }
        }

        function renderSimilar(scoredBooks) {
            const container = document.getElementById('similar-container');
            const list = document.getElementById('similar-list');
            container.style.display = 'block';
            list.innerHTML = '';

            scoredBooks.forEach(item => {
                const b = item.book;
                const reasonText = [...new Set(item.reasons)].join('\n'); // Dedupe whole reason lines

                // Image Logic: Finna -> OpenLibrary Fallback -> Placeholder
                let imgSrc = (b.images && b.images.length) ? `https://api.finna.fi${b.images[0]}` : '';
                if (!imgSrc && b.isbn) {
                    const isbn = Array.isArray(b.isbn) ? b.isbn[0] : b.isbn;
                    imgSrc = `https://covers.openlibrary.org/b/isbn/${isbn}-M.jpg`;
                }

                const el = document.createElement('div');
                el.style.cssText = "width: 100px; cursor: pointer; flex-shrink:0;";
                el.onclick = () => window.location.href = `book.html?id=${b.id}`;
                el.title = `Miksi tämä? \n${reasonText}`;

                el.innerHTML = `
                    <div style="width:100%; aspect-ratio:2/3; background:#f0f0f0; border-radius:4px; overflow:hidden; margin-bottom:4px; position:relative;">
                        ${imgSrc ? `<img src="${imgSrc}" style="width:100%; height:100%; object-fit:cover;" onerror="this.style.display='none'">` : '<div style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#ccc; font-size:0.8rem;">Ei kuvaa</div>'}
                    </div>
                    <div style="font-size:0.75rem; font-weight:500; line-height:1.2; overflow:hidden; text-overflow:ellipsis; display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical;">${b.title}</div>
                `;
                list.appendChild(el);
            });
        }

        async function fetchReviews(isbn) {
            if (Array.isArray(isbn)) isbn = isbn[0];
            const url = `https://openlibrary.org/search.json?q=${isbn}&fields=ratings_average,ratings_count,key&limit=1`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.docs && data.docs.length > 0 && data.docs[0].ratings_average) {
                    renderRating(data.docs[0]);
                }
            } catch (e) { }
        }

        async function fetchReviewsByTitle(title, author) {
            const url = `https://openlibrary.org/search.json?title=${encodeURIComponent(title)}&author=${encodeURIComponent(author)}&fields=ratings_average,ratings_count&limit=1`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                if (data.docs && data.docs.length > 0 && data.docs[0].ratings_average) {
                    renderRating(data.docs[0]);
                }
            } catch (e) { }
        }

        function renderRating(data) {
            const container = document.getElementById('reviews-container');
            container.style.display = 'block';
            const score = Math.round(data.ratings_average * 10) / 10;
            const count = data.ratings_count;
            const stars = "★".repeat(Math.round(score)) + "☆".repeat(5 - Math.round(score));

            document.getElementById('review-content').innerHTML = `
                <div style="display:flex; align-items:center; gap:8px;">
                    <span style="color:#e6b800; font-size:1.2rem; cursor:help;" title="Lähde: OpenLibrary">${stars}</span>
                    <span style="font-weight:700; font-size:1.1rem;">${score}</span>
                    <span style="color:#57606a; font-size:0.9rem;">(${count} arvostelua)</span>
                </div>
            `;
        }

        async function enrichBookData(title, author) {
            if (!title) return;
            console.log("Attempting to enrich data for", title);

            // Search for other records of the same book (e.g. Helmet libraries often have descriptions)
            const params = new URLSearchParams({
                lookfor: `"${title}" ${author}`, // Quote title for exact phrase match
                type: 'AllFields',
                limit: 5,
                'field[]': ['summary', 'id']
            });

            try {
                const res = await fetch(`https://api.finna.fi/v1/search?${params.toString()}`);
                const data = await res.json();

                if (data.records && data.records.length > 0) {
                    // Find the first record that actually has a summary
                    const betterRecord = data.records.find(r => r.summary && r.summary.length > 0);
                    if (betterRecord) {
                        console.log("Found better description from", betterRecord.id);
                        const desc = Array.isArray(betterRecord.summary) ? betterRecord.summary.join('\n\n') : betterRecord.summary;
                        const dEl = document.getElementById('book-desc');
                        dEl.innerText = desc;
                        dEl.parentElement.style.display = 'block'; // Show if found
                    }
                }
            } catch (e) {
                console.warn("Enrichment failed", e);
            }
        }

        function extractAuthor(book) {
            if (!book.authors) return "";
            const primary = book.authors.primary || Object.values(book.authors)[0];
            return primary ? Object.keys(primary)[0] : "";
        }

        function renderBook(book) {
            document.getElementById('book-title').textContent = book.title;

            // Original Title
            let ot = "";
            if (book.notes) {
                const otNote = book.notes.find(n => n.includes("Alkuteos:") || n.includes("Alkuperäisteos:"));
                if (otNote) ot = otNote;
            }
            if (ot) {
                document.getElementById('book-original-title').textContent = ot;
                document.getElementById('book-original-title').style.display = 'block';
            }

            const authorName = extractAuthor(book) || "Tuntematon";
            document.getElementById('book-author').textContent = authorName;
            document.getElementById('book-year').textContent = book.year || "";

            let desc = "";
            if (book.summary && book.summary.length > 0) {
                desc = Array.isArray(book.summary) ? book.summary.join('\n\n') : book.summary;
            }

            const descEl = document.getElementById('book-desc');
            const descContainer = descEl.parentElement;

            if (desc) {
                descEl.innerText = desc;
                descContainer.style.display = 'block';
            } else {
                descEl.innerText = "";
                descContainer.style.display = 'none';
            }

            // Image with Fallback (Finna -> OpenLibrary -> Placeholder)
            const coverDiv = document.getElementById('book-cover');
            let imgSrc = (book.images && book.images.length > 0) ? `https://api.finna.fi${book.images[0]}` : null;

            if (!imgSrc && book.isbn) {
                const isbn = Array.isArray(book.isbn) ? book.isbn[0] : book.isbn;
                imgSrc = `https://covers.openlibrary.org/b/isbn/${isbn}-L.jpg`; // Use Large size for main cover
            }

            if (imgSrc) {
                coverDiv.innerHTML = `<img src="${imgSrc}" alt="${book.title}" style="width:100%; height:100%; object-fit:cover;" onerror="this.parentElement.innerHTML='<div style=\\'display:flex; align-items:center; justify-content:center; height:100%; color:#888;\\'>Ei kuvaa</div>'">`;
            } else {
                coverDiv.innerHTML = `<div style="display:flex; align-items:center; justify-content:center; height:100%; color:#888;">Ei kuvaa</div>`;
            }
        }
    </script>
</body>

</html>